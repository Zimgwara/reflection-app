<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Technical Reflection App</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <meta name="theme-color" content="#2c3e50">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.4/dist/quill.snow.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    
    <!-- Netlify Identity Widget Script -->
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <!-- NEW: Firebase SDKs -->
    <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBif3Ejzt-KiY1vDyFPtRQjX5ne-SnV4dM",
    authDomain: "reflectdent-74d8c.firebaseapp.com",
    projectId: "reflectdent-74d8c",
    storageBucket: "reflectdent-74d8c.firebasestorage.app",
    messagingSenderId: "510796139347",
    appId: "1:510796139347:web:426f0414b5f20f350f2fa6",
    measurementId: "G-WSTTV8EFWX"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
</head>
<body>
    <div class="app-wrapper">
        <div data-netlify-identity-button></div>

        <!-- NEW: Main content area will now toggle between editor and list view -->
        <div id="app-content" style="display: none;">
            
            <!-- NEW: Reflections List View -->
            <div id="reflections-list-view">
                <div class="list-header">
                    <h2>My Reflections</h2>
                    <button id="newReflectionBtn" class="new-reflection-btn">+ New Reflection</button>
                </div>
                <div id="reflections-list-container">
                    <!-- Saved reflections will be dynamically inserted here -->
                </div>
            </div>

            <!-- Editor View (initially hidden) -->
            <main class="container" id="editor-view" style="display: none;">
                <div class="top-header">
                    <div class="logo-container">
                        <img src="company_logo.png" alt="Logo" class="company-logo" onerror="this.onerror=null;this.src='https://placehold.co/160x80/cccccc/333333?text=Logo';">
                    </div>
                    <div class="theme-switch-wrapper top-right-corner">
                        <label class="theme-switch" for="themeToggle">
                            <input type="checkbox" id="themeToggle" role="switch">
                            <div class="slider round"></div>
                        </label>
                        <span class="theme-label">Dark Mode</span>
                    </div>
                </div>

                <!-- NEW: Reflection Title Input -->
                <input type="text" id="reflectionTitle" class="reflection-title-input" placeholder="Give your reflection a title...">
                
                <p class="last-saved-timestamp" id="lastSavedTimestamp">Not saved yet</p>

                <!-- Reflection, Media, Feedback sections remain the same -->
                 <div class="section-block">
                    <h2>Your Reflection:</h2>
                    <div id="reflection" class="quill-editor"></div>
                </div>
                <div class="section-block">
                    <h2>Attach Relevant Media</h2>
                    <div class="image-upload-section">
                        <div class="image-upload-buttons">
                            <label class="custom-file-upload" for="imageUploadCamera">üì∏ Take Photo</label>
                            <input type="file" id="imageUploadCamera" accept="image/*" capture="camera" multiple>
                            <label class="custom-file-upload" for="imageUploadGallery">üñºÔ∏è Upload Image</label>
                            <input type="file" id="imageUploadGallery" accept="image/*" multiple>
                        </div>
                        <div id="mediaPreviewContainer">
                            <span class="no-media-selected" id="noMediaMessage">No media selected yet.</span>
                        </div>
                    </div>
                </div>
                <div class="section-block" id="lecturerFeedbackSection">
                    <h2>Lecturer Feedback</h2>
                    <div id="feedback" class="quill-editor"></div>
                </div>

                <!-- NEW: Simplified Action Buttons -->
                <div class="action-button-group">
                    <button id="saveReflectionBtn" class="action-btn save-btn">Save Reflection</button>
                    <button id="deleteReflectionBtn" class="action-btn delete-btn" style="display: none;">Delete</button>
                    <button class="action-btn" onclick="printPage()">Print / Save as PDF</button>
                </div>
                <button id="backToListBtn" class="back-btn">‚Üê Back to List</button>
            </main>
        </div>
    </div>

    <!-- Script Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.4/dist/quill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script type="module" src="script.js"></script>

    <!-- Login & Theme Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        let appInitialized = false;
        
        const app = initializeApp(window.firebaseConfig);
        const auth = getAuth(app);
        window.auth = auth; // Make auth globally available

        onAuthStateChanged(auth, user => {
            const appContent = document.getElementById('app-content');
            if (user) {
                appContent.style.display = 'block';
                if (!appInitialized) {
                    window.initializeApp(user.uid); // Pass UID to main script
                    appInitialized = true;
                }
            } else {
                appContent.style.display = 'none';
            }
        });

        netlifyIdentity.on('login', user => {
            // This part might need custom token logic in a real-world secure app,
            // but for now, we rely on Netlify's user object and will use anonymous Firebase auth.
            signInAnonymously(auth);
            netlifyIdentity.close();
        });

        netlifyIdentity.on('logout', () => {
            auth.signOut();
            window.location.reload();
        });
        
        if (netlifyIdentity.currentUser()) {
             signInAnonymously(auth);
        }
    </script>
    <script>
        // Standalone Dark Mode Logic
        const themeToggle = document.getElementById('themeToggle');
        if(themeToggle){
            const body = document.body;
            const themeKey = 'myTechnicalReflection_theme';
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    body.classList.add('dark-mode');
                    themeToggle.checked = true;
                } else {
                    body.classList.remove('dark-mode');
                    themeToggle.checked = false;
                }
            };
            const savedTheme = localStorage.getItem(themeKey);
            applyTheme(savedTheme);
            themeToggle.addEventListener('change', () => {
                const isDarkMode = themeToggle.checked;
                localStorage.setItem(themeKey, isDarkMode ? 'dark' : 'light');
                applyTheme(isDarkMode ? 'dark' : 'light');
            });
        }
    </script>
</body>
</html>

