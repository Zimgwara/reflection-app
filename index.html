<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Technical Reflection App</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <meta name="theme-color" content="#2c3e50">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.4/dist/quill.snow.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
    <div class="app-wrapper">
        <div id="app-content" style="display: none;">
            <main class="container">
                <div class="top-header">
                    <div class="logo-container">
                        <img src="company_logo.png" alt="Company Logo" class="company-logo" onerror="this.onerror=null;this.src='https://placehold.co/160x80/cccccc/333333?text=Logo';">
                    </div>
                    <div data-netlify-identity-button></div>
                    <div class="theme-switch-wrapper top-right-corner">
                        <label class="theme-switch" for="themeToggle">
                            <input type="checkbox" id="themeToggle" role="switch">
                            <div class="slider round"></div>
                        </label>
                        <span class="theme-label">Dark Mode</span>
                    </div>
                </div>

                <div id="reflectionsListContainer">
                    <h1>My Reflections</h1>
                    <button id="newReflectionBtn">New Reflection</button>
                    <ul id="reflectionsList"></ul>
                </div>

                <div id="reflectionEditorContainer" class="hidden">
                    <h1>My Technical Reflection</h1>
                    <input type="text" id="reflectionTitle" placeholder="Enter a title for this reflection...">
                    <p class="last-saved-timestamp" id="lastSavedTimestamp">Last saved: Never</p>
                    <div class="section-block">
                        <h2>Your Reflection:</h2>
                        <div id="reflection" class="quill-editor"></div>
                    </div>
                    <div class="section-block">
                        <h2>Attach Relevant Media</h2>
                        <div class="image-upload-section">
                            <label class="custom-file-upload" for="mediaUpload">Upload Image/Video</label>
                            <input type="file" id="mediaUpload" accept="image/*,video/*" multiple>
                            <div id="mediaPreviewContainer"></div>
                        </div>
                    </div>
                    <div class="section-block" id="lecturerFeedbackSection">
                        <h2>Lecturer Feedback</h2>
                        <div id="feedback" class="quill-editor"></div>
                    </div>
                    <div class="action-button-group">
                        <button id="saveReflectionBtn">Save and Close</button>
                        <button id="deleteReflectionBtn" class="delete-btn">Delete Reflection</button>
                        <button class="print-btn" onclick="printPage()">Print / Save as PDF</button>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <p id="modalMessage">Are you sure you want to delete this reflection?</p>
            <div class="modal-buttons">
                <button id="confirmYes" class="modal-btn confirm-yes-btn">Yes, Delete</button>
                <button id="confirmNo" class="modal-btn confirm-no-btn">Cancel</button>
            </div>
        </div>
    </div>
    
    <p id="message" aria-live="polite"></p>

    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.4/dist/quill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    
    <script type="module">
        // --- Firebase and Main App Logic ---
        
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG OBJECT HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBif3Ejzt-KiY1vDyFPtRQjX5ne-SnV4dM",
            authDomain: "reflectdent-74d8c.firebaseapp.com",
            projectId: "reflectdent-74d8c",
            storageBucket: "reflectdent-74d8c.appspot.com",
            messagingSenderId: "510796139347",
            appId: "1:510796139347:web:426f0414b5f20f350f2fa6",
            measurementId: "G-WSTTV8EFWX"
        };
        // --- END OF FIREBASE CONFIG ---

        // Global variables for the main application
        let reflectionQuill, feedbackQuill;
        let db, auth;
        let currentUserId = null;
        let currentReflectionId = null;
        const reflectionsCache = new Map();

        // --- MAIN APPLICATION LOGIC (previously script.js) ---
        function initializeMainApp(userId) {
            currentUserId = userId;
            console.log("Main app initialized for user:", userId);

            const toolbarOptions = [
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                ['clean']
            ];

            reflectionQuill = new Quill('#reflection', { theme: 'snow', modules: { toolbar: toolbarOptions } });
            feedbackQuill = new Quill('#feedback', { theme: 'snow', modules: { toolbar: toolbarOptions } });

            const newReflectionBtn = document.getElementById('newReflectionBtn');
            const saveReflectionBtn = document.getElementById('saveReflectionBtn');
            const deleteReflectionBtn = document.getElementById('deleteReflectionBtn');
            const mediaUpload = document.getElementById('mediaUpload');

            newReflectionBtn.addEventListener('click', showEditorForNewReflection);
            saveReflectionBtn.addEventListener('click', saveCurrentReflection);
            deleteReflectionBtn.addEventListener('click', () => showConfirmationModal(currentReflectionId));
            mediaUpload.addEventListener('change', handleMediaUpload);
            
            listenForReflections();
        }
        
        // UI Navigation
        const reflectionsListContainer = document.getElementById('reflectionsListContainer');
        const reflectionEditorContainer = document.getElementById('reflectionEditorContainer');

        function showListView() {
            reflectionsListContainer.classList.remove('hidden');
            reflectionEditorContainer.classList.add('hidden');
            currentReflectionId = null;
        }

        function showEditorView() {
            reflectionsListContainer.classList.add('hidden');
            reflectionEditorContainer.classList.remove('hidden');
        }

        function showEditorForNewReflection() {
            currentReflectionId = null;
            document.getElementById('reflectionTitle').value = '';
            reflectionQuill.setText('');
            feedbackQuill.setText('');
            document.getElementById('mediaPreviewContainer').innerHTML = '';
            document.getElementById('lastSavedTimestamp').textContent = 'Last saved: Never';
            showEditorView();
        }

        // Firestore Logic
        function listenForReflections() {
            if (!currentUserId) return;
            const reflectionsCol = collection(db, 'users', currentUserId, 'reflections');
            const q = query(reflectionsCol, orderBy('updatedAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                const reflectionsList = document.getElementById('reflectionsList');
                reflectionsList.innerHTML = '';
                snapshot.docs.forEach(doc => {
                    const reflection = { id: doc.id, ...doc.data() };
                    reflectionsCache.set(reflection.id, reflection);
                    
                    const li = document.createElement('li');
                    li.textContent = reflection.title || 'Untitled Reflection';
                    li.dataset.id = reflection.id;
                    li.addEventListener('click', () => loadReflectionIntoEditor(reflection.id));
                    reflectionsList.appendChild(li);
                });
            });
        }

        function loadReflectionIntoEditor(reflectionId) {
            const reflection = reflectionsCache.get(reflectionId);
            if (!reflection) return;

            currentReflectionId = reflectionId;
            document.getElementById('reflectionTitle').value = reflection.title || '';
            reflectionQuill.root.innerHTML = reflection.reflectionContent || '';
            feedbackQuill.root.innerHTML = reflection.feedbackContent || '';
            
            const timestamp = reflection.updatedAt?.toDate().toLocaleString() || 'Never';
            document.getElementById('lastSavedTimestamp').textContent = `Last saved: ${timestamp}`;

            const mediaContainer = document.getElementById('mediaPreviewContainer');
            mediaContainer.innerHTML = '';
            if (reflection.mediaUrls && reflection.mediaUrls.length > 0) {
                reflection.mediaUrls.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    mediaContainer.appendChild(img);
                });
            }
            showEditorView();
        }

        async function saveCurrentReflection() {
            if (!currentUserId) return;

            const reflectionData = {
                title: document.getElementById('reflectionTitle').value || 'Untitled Reflection',
                reflectionContent: reflectionQuill.root.innerHTML,
                feedbackContent: feedbackQuill.root.innerHTML,
                mediaUrls: Array.from(document.querySelectorAll('#mediaPreviewContainer img')).map(img => img.src),
                updatedAt: serverTimestamp()
            };

            try {
                if (currentReflectionId) {
                    const docRef = doc(db, 'users', currentUserId, 'reflections', currentReflectionId);
                    await updateDoc(docRef, reflectionData);
                    showAppMessage('Reflection updated!');
                } else {
                    const collectionRef = collection(db, 'users', currentUserId, 'reflections');
                    await addDoc(collectionRef, reflectionData);
                    showAppMessage('Reflection saved!');
                }
                showListView();
            } catch (error) {
                console.error("Error saving reflection: ", error);
                showAppMessage('Error: Could not save reflection.');
            }
        }
        
        async function deleteReflection(reflectionId) {
            if (!currentUserId || !reflectionId) return;
            try {
                const docRef = doc(db, 'users', currentUserId, 'reflections', reflectionId);
                await deleteDoc(docRef);
                showAppMessage('Reflection deleted.');
                showListView();
            } catch (error) {
                console.error("Error deleting reflection: ", error);
                showAppMessage('Error: Could not delete reflection.');
            }
        }
        
        // Media Upload Logic
        async function handleMediaUpload(event) {
            const files = event.target.files;
            const cloudName = 'dslh2taed';
            const uploadPreset = 'Dental';
            const url = `https://api.cloudinary.com/v1_1/${cloudName}/upload`;
            const mediaContainer = document.getElementById('mediaPreviewContainer');

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', uploadPreset);

                try {
                    const response = await fetch(url, { method: 'POST', body: formData });
                    const data = await response.json();
                    
                    const img = document.createElement('img');
                    img.src = data.secure_url;
                    mediaContainer.appendChild(img);
                } catch (error) {
                    console.error('Error uploading media:', error);
                    showAppMessage('Error uploading media.');
                }
            }
        }

        // Modal and Message helpers
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const confirmYesBtn = document.getElementById('confirmYes');
        const confirmNoBtn = document.getElementById('confirmNo');

        function showConfirmationModal(reflectionId) {
            if(!reflectionId) return;
            confirmationModal.classList.add('active');
            confirmYesBtn.onclick = () => {
                deleteReflection(reflectionId);
                confirmationModal.classList.remove('active');
            };
            confirmNoBtn.onclick = () => confirmationModal.classList.remove('active');
        }

        function showAppMessage(messageText) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = messageText;
            messageElement.classList.add('show-message');
            setTimeout(() => {
                messageElement.classList.remove('show-message');
            }, 3000);
        }

        // Print function
        window.printPage = function() {
            window.print();
        }

        // --- FIREBASE AUTH & NETLIFY IDENTITY BRIDGE ---
        let appInitialized = false;

        try {
            document.addEventListener('DOMContentLoaded', () => {
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    const savedTheme = localStorage.getItem('myTechnicalReflection_theme') || 'light';
                    if (savedTheme === 'dark') {
                        document.body.classList.add('dark-mode');
                        themeToggle.checked = true;
                    }
                    themeToggle.addEventListener('change', () => {
                        document.body.classList.toggle('dark-mode');
                        const isDarkMode = document.body.classList.contains('dark-mode');
                        localStorage.setItem('myTechnicalReflection_theme', isDarkMode ? 'dark' : 'light');
                    });
                }
            });
            
            console.log("Attempting to initialize Firebase...");
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully!");

            async function authenticateWithFirebase() {
                const netlifyUser = netlifyIdentity.currentUser();
                if (!netlifyUser) return;
                try {
                    const response = await fetch('/.netlify/functions/get-firebase-token', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${netlifyUser.token.access_token}` }
                    });
                    if (!response.ok) throw new Error(`Function returned status: ${response.status}`);
                    const data = await response.json();
                    await signInWithCustomToken(auth, data.token);
                } catch (error) {
                    console.error("Firebase auth bridge failed:", error);
                }
            }

            onAuthStateChanged(auth, (firebaseUser) => {
                if (firebaseUser) {
                    document.getElementById('app-content').style.display = 'block';
                    if (!appInitialized) {
                        initializeMainApp(firebaseUser.uid);
                        appInitialized = true;
                    }
                }
            });

            netlifyIdentity.on('login', () => { netlifyIdentity.close(); authenticateWithFirebase(); });
            netlifyIdentity.on('logout', async () => {
                if (auth) await signOut(auth);
                window.location.reload();
            });
            netlifyIdentity.on('init', (user) => { if (user) authenticateWithFirebase(); });

        } catch (error) {
            console.error("A FATAL ERROR OCCURRED DURING FIREBASE INITIALIZATION.", error);
            document.body.innerHTML = `<div style="padding: 40px; font-family: sans-serif; text-align: center;"><h1>Application Error</h1><p>Could not initialize the database. Please check the browser console for a specific error message.</p></div>`;
        }
    </script>
</body>
</html>

