<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Technical Reflection App</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <meta name="theme-color" content="#2c3e50">

    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.4/dist/quill.snow.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    
    <!-- Netlify Identity Widget Script -->
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
    <!-- This wrapper helps center the entire application -->
    <div class="app-wrapper">
        <!-- The Login/Logout button is now outside the hidden content, but inside the centered wrapper -->
        <div data-netlify-identity-button></div>

        <!-- This content is hidden until the user logs in -->
        <div id="app-content" style="display: none;">
            <main class="container">
                <!-- The header is now back INSIDE the main container -->
                <div class="top-header">
                    <div class="logo-container">
                        <img src="company_logo.png" alt="[Your Company Name] Logo" class="company-logo" onerror="this.onerror=null;this.src='https://placehold.co/160x80/cccccc/333333?text=Logo';">
                    </div>
                    <div class="theme-switch-wrapper top-right-corner">
                        <label class="theme-switch" for="themeToggle">
                            <input type="checkbox" id="themeToggle" role="switch">
                            <div class="slider round"></div>
                        </label>
                        <span class="theme-label">Dark Mode</span>
                    </div>
                </div>

                <h1>My Technical Reflection</h1>
                <p class="last-saved-timestamp" id="lastSavedTimestamp">Last saved: Never</p>

                <!-- ... ALL of your other sections and modals go here as they were ... -->
                <!-- (Reflection, Media, Feedback, Buttons, Modals, etc.) -->

                <div class="section-block">
                    <h2>Your Reflection:</h2>
                    <label for="reflection">
                        What are your reflections on this piece of work? What went well, and what didn't? What will you work on or change in the future?
                    </label>
                    <div class="prompt-selection">
                        <label for="promptSelect">Choose a prompt:</label>
                        <select id="promptSelect">
                            <option value="">-- Select a prompt --</option>
                            <option value="well">What went well?</option>
                            <option value="challenging">What was challenging?</option>
                            <option value="future">What will you work on or change in the future?</option>
                            <option value="star">STAR Reflection (Situation, Task, Action, Result)</option>
                        </select>
                        <button id="insertPromptBtn">Insert Prompt</button>
                    </div>
                    <div id="reflection" class="quill-editor"></div>
                    <div class="word-char-count">
                        <span id="reflectionWordCount">0 words</span> / <span id="reflectionCharCount">0 characters</span>
                    </div>
                </div>
    
                <div class="section-block">
                    <h2 data-original-text="Attach Relevant Media (Optional)">Attach Relevant Media (Optional)</h2>
                    <div class="image-upload-section">
                        <div class="image-upload-buttons">
                            <label class="custom-file-upload" for="imageUploadCamera">
                                <span role="img" aria-label="Camera">üì∏</span> Take Photo
                            </label>
                            <input type="file" id="imageUploadCamera" accept="image/*" capture="camera" multiple>
    
                            <label class="custom-file-upload" for="imageUploadGallery">
                                <span role="img" aria-label="Gallery">üñºÔ∏è</span> Upload Existing Image
                            </label>
                            <input type="file" id="imageUploadGallery" accept="image/*" multiple>
                            
                            <label class="custom-file-upload" for="videoUploadCamera">
                                <span role="img" aria-label="Video Camera">üìπ</span> Record Video
                            </label>
                            <input type="file" id="videoUploadCamera" accept="video/*" capture="user" multiple>
    
                            <label class="custom-file-upload" for="videoUploadGallery">
                                <span role="img" aria-label="Video Gallery">üé¨</span> Upload Existing Video
                            </label>
                            <input type="file" id="videoUploadGallery" accept="video/*" multiple>
                        </div>
                        
                        <div id="mediaPreviewContainer"> <span class="no-media-selected" id="noMediaMessage">No media selected yet.</span> </div>
                    </div>
                </div>
    
                <div class="section-block" id="lecturerFeedbackSection">
                    <h2>Lecturer Feedback</h2>
                    <label for="feedback">
                        Record the lecturer's feedback here.
                    </label>
                    <div class="input-group">
                        <div id="feedback" class="quill-editor"></div>
                        <button class="microphone-button" data-target="feedback" title="Start/Stop Dictation">üéôÔ∏è</button>
                    </div>
                    <div class="word-char-count">
                        <span id="feedbackWordCount">0 words</span> / <span id="feedbackCharCount">0 characters</span>
                    </div>
                </div>
    
                <div class="action-button-group">
                    <button class="copy-btn" onclick="copyContent()">Copy to Clipboard</button>
                    <button class="print-btn" onclick="printPage()">Print / Save as PDF</button>
                    <button class="share-btn" onclick="shareContent()">Share</button>
                    <button class="download-html-btn" onclick="downloadAsHtml()">Download as HTML File</button>
                </div>
                
                <div class="clear-data-group">
                    <button id="clearAllDataBtn" class="clear-btn">Clear All Data</button>
                </div>
    
                <p id="message" aria-live="polite"></p>
    
                <div id="instructions-container" class="instructions-hidden">
                    <p id="instruction-text"></p>
                    <button id="close-instructions" onclick="hideInstructions()">Got It!</button>
                </div>
    
                <div id="confirmationModal" class="modal-overlay">
                    <div class="modal-content">
                        <p id="modalMessage">Are you sure you want to clear all data? This action cannot be undone.</p>
                        <div class="modal-buttons">
                            <button id="confirmYes" class="modal-btn confirm-yes-btn">Yes, Clear All</button>
                            <button id="confirmNo" class="modal-btn confirm-no-btn">No, Cancel</button>
                        </div>
                    </div>
                </div>
    
                <div id="imageCropperModal" class="modal-overlay">
                    <div class="modal-content cropper-modal">
                        <p class="cropper-modal-title">Crop & Resize Image</p>
                        <div class="img-container">
                            <img id="imageToCrop" src="" alt="Image to Crop">
                        </div>
                        <div class="cropper-controls">
                            <button class="cropper-btn" id="rotateLeftBtn" title="Rotate Left">‚ü≤</button>
                            <button class="cropper-btn" id="rotateRightBtn" title="Rotate Right">‚ü≥</button>
                            <button class="cropper-btn" id="zoomInBtn" title="Zoom In">+</button>
                            <button class="cropper-btn" id="zoomOutBtn" title="Zoom Out">-</button>
                            <button class="cropper-btn" id="resetCropperBtn" title="Reset">‚ü≥ Reset</button>
                        </div>
                        <div class="modal-buttons">
                            <button id="cropDoneBtn" class="modal-btn confirm-yes-btn">Done Cropping</button>
                            <button id="cropCancelBtn" class="modal-btn confirm-no-btn">Cancel</button>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Original script dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.4/dist/quill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="script.js"></script>

    <!-- Script to handle login state and call initializeApp() from script.js -->
    <script>
        let appInitialized = false;

        document.addEventListener('DOMContentLoaded', () => {
            const appContent = document.getElementById('app-content');
            const loginButtonContainer = document.querySelector('[data-netlify-identity-button]');

            const updateUserState = (user) => {
                if (user) {
                    appContent.style.display = 'block';
                    const appWrapper = document.querySelector('.app-wrapper');
                    appWrapper.insertBefore(loginButtonContainer, appContent);

                    if (!appInitialized) {
                        initializeApp();
                        appInitialized = true;
                    }
                } else {
                    appContent.style.display = 'none';
                }
            };

            netlifyIdentity.on('init', user => updateUserState(user));
            netlifyIdentity.on('login', user => {
                updateUserState(user);
                netlifyIdentity.close();
            });
            netlifyIdentity.on('logout', () => {
                updateUserState(null);
                appInitialized = false;
            });
        });
    </script>

    <!-- NEW: Standalone Dark Mode Logic -->
    <script>
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        const themeKey = 'myTechnicalReflection_theme';

        const applyTheme = (theme) => {
            if (theme === 'dark') {
                body.classList.add('dark-mode');
                if(themeToggle) themeToggle.checked = true;
            } else {
                body.classList.remove('dark-mode');
                if(themeToggle) themeToggle.checked = false;
            }
        };

        const savedTheme = localStorage.getItem(themeKey);
        applyTheme(savedTheme);

        if(themeToggle){
            themeToggle.addEventListener('change', () => {
                const isDarkMode = themeToggle.checked;
                if (isDarkMode) {
                    body.classList.add('dark-mode');
                    localStorage.setItem(themeKey, 'dark');
                } else {
                    body.classList.remove('dark-mode');
                    localStorage.setItem(themeKey, 'light');
                }
            });
        }
    </script>
</body>
</html>

