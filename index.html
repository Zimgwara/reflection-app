<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Technical Reflection App</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <!-- Reminder: The 'icons' folder must exist in your project for this to work -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <meta name="theme-color" content="#2c3e50">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.4/dist/quill.snow.css" rel="stylesheet">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
    <div class="app-wrapper">
        <div id="app-content" style="display: none;">
            <main class="container">
                <div class="top-header">
                    <div class="logo-container">
                        <img src="company_logo.png" alt="Company Logo" class="company-logo" onerror="this.onerror=null;this.src='https://placehold.co/160x80/cccccc/333333?text=Logo';">
                    </div>
                    <div data-netlify-identity-button></div>
                    <div class="theme-switch-wrapper top-right-corner">
                        <label class="theme-switch" for="themeToggle">
                            <input type="checkbox" id="themeToggle" role="switch">
                            <div class="slider round"></div>
                        </label>
                        <span class="theme-label">Dark Mode</span>
                    </div>
                </div>
                <div id="reflectionsListContainer">
                    <h1>My Reflections</h1>
                    <button id="newReflectionBtn">New Reflection</button>
                    <ul id="reflectionsList"></ul>
                </div>
                <div id="reflectionEditorContainer" class="hidden">
                    <h1>My Technical Reflection</h1>
                    <input type="text" id="reflectionTitle" placeholder="Enter a title for this reflection...">
                    <p class="last-saved-timestamp" id="lastSavedTimestamp">Last saved: Never</p>
                    <div class="section-block">
                        <h2>Your Reflection:</h2>
                        <div id="reflection" class="quill-editor"></div>
                    </div>
                    <div class="section-block">
                        <h2>Attach Relevant Media</h2>
                        <div class="image-upload-section">
                            <label class="custom-file-upload" for="mediaUpload">Upload Image/Video</label>
                            <input type="file" id="mediaUpload" accept="image/*,video/*" multiple>
                            <div id="mediaPreviewContainer"></div>
                        </div>
                    </div>
                    <div class="section-block" id="lecturerFeedbackSection">
                        <h2>Lecturer Feedback</h2>
                        <div id="feedback" class="quill-editor"></div>
                    </div>
                    <div class="action-button-group">
                        <button id="saveReflectionBtn">Save and Close</button>
                        <button id="deleteReflectionBtn" class="delete-btn">Delete Reflection</button>
                        <button class="print-btn">Print / Save as PDF</button>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <p id="modalMessage">Are you sure you want to delete this reflection?</p>
            <div class="modal-buttons">
                <button id="confirmYes" class="modal-btn confirm-yes-btn">Yes, Delete</button>
                <button id="confirmNo" class="modal-btn confirm-no-btn">Cancel</button>
            </div>
        </div>
    </div>
    
    <p id="message" aria-live="polite"></p>

    <!-- External libraries are loaded first -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.4/dist/quill.min.js"></script>
    
    <!-- All application code is now in this single, robust module script -->
    <script type="module">
        // --- STEP 1: Firebase Configuration ---
        // PASTE YOUR ENTIRE FIREBASE CONFIG OBJECT FROM THE FIREBASE CONSOLE HERE.
        // It should start with 'const firebaseConfig = {' and end with '};'
        const firebaseConfig = {
            apiKey: "PASTE_YOUR_API_KEY",
            authDomain: "PASTE_YOUR_AUTH_DOMAIN",
            projectId: "PASTE_YOUR_PROJECT_ID",
            storageBucket: "PASTE_YOUR_STORAGE_BUCKET",
            messagingSenderId: "PASTE_YOUR_SENDER_ID",
            appId: "PASTE_YOUR_APP_ID"
        };
        
        // --- STEP 2: Import Firebase Modules ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // This is a safety wrapper to catch any critical errors during setup.
        try {
            // --- STEP 3: Initialize Firebase ---
            console.log("STEP 1: Initializing Firebase...");
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            console.log("STEP 2: Firebase initialized successfully!");

            // --- STEP 4: Application Logic ---
            let reflectionQuill, feedbackQuill;
            let currentUserId = null;
            let currentReflectionId = null;
            const reflectionsCache = new Map();
            let appIsInitialized = false;

            const reflectionsListContainer = document.getElementById('reflectionsListContainer');
            const reflectionEditorContainer = document.getElementById('reflectionEditorContainer');
            
            function initializeMainApp(userId) {
                console.log("STEP 6: Initializing main application for user:", userId);
                currentUserId = userId;

                const toolbarOptions = [
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['clean']
                ];

                reflectionQuill = new Quill('#reflection', { theme: 'snow', modules: { toolbar: toolbarOptions } });
                feedbackQuill = new Quill('#feedback', { theme: 'snow', modules: { toolbar: toolbarOptions } });

                document.getElementById('newReflectionBtn').addEventListener('click', showEditorForNewReflection);
                document.getElementById('saveReflectionBtn').addEventListener('click', saveCurrentReflection);
                document.getElementById('deleteReflectionBtn').addEventListener('click', () => showConfirmationModal(currentReflectionId));
                document.getElementById('mediaUpload').addEventListener('change', handleMediaUpload);
                document.querySelector('.print-btn').addEventListener('click', printPage);

                listenForReflections();
                console.log("STEP 7: Main application is ready!");
            }

            function showListView() {
                reflectionsListContainer.classList.remove('hidden');
                reflectionEditorContainer.classList.add('hidden');
                currentReflectionId = null;
            }

            function showEditorView() {
                reflectionsListContainer.classList.add('hidden');
                reflectionEditorContainer.classList.remove('hidden');
            }

            function showEditorForNewReflection() {
                currentReflectionId = null;
                document.getElementById('reflectionTitle').value = '';
                reflectionQuill.setText('');
                feedbackQuill.setText('');
                document.getElementById('mediaPreviewContainer').innerHTML = '';
                document.getElementById('lastSavedTimestamp').textContent = 'Last saved: Never';
                showEditorView();
            }

            function listenForReflections() {
                if (!currentUserId) return;
                const reflectionsCol = collection(db, 'users', currentUserId, 'reflections');
                const q = query(reflectionsCol, orderBy('updatedAt', 'desc'));

                onSnapshot(q, (snapshot) => {
                    const reflectionsList = document.getElementById('reflectionsList');
                    reflectionsList.innerHTML = '';
                    snapshot.docs.forEach(doc => {
                        const reflection = { id: doc.id, ...doc.data() };
                        reflectionsCache.set(reflection.id, reflection);
                        const li = document.createElement('li');
                        li.textContent = reflection.title || 'Untitled Reflection';
                        li.dataset.id = reflection.id;
                        li.addEventListener('click', () => loadReflectionIntoEditor(reflection.id));
                        reflectionsList.appendChild(li);
                    });
                });
            }

            function loadReflectionIntoEditor(reflectionId) {
                const reflection = reflectionsCache.get(reflectionId);
                if (!reflection) return;

                currentReflectionId = reflectionId;
                document.getElementById('reflectionTitle').value = reflection.title || '';
                reflectionQuill.root.innerHTML = reflection.reflectionContent || '';
                feedbackQuill.root.innerHTML = reflection.feedbackContent || '';

                const timestamp = reflection.updatedAt?.toDate().toLocaleString() || 'Never';
                document.getElementById('lastSavedTimestamp').textContent = `Last saved: ${timestamp}`;

                const mediaContainer = document.getElementById('mediaPreviewContainer');
                mediaContainer.innerHTML = '';
                if (reflection.mediaUrls && reflection.mediaUrls.length > 0) {
                    reflection.mediaUrls.forEach(url => {
                        const img = document.createElement('img');
                        img.src = url;
                        mediaContainer.appendChild(img);
                    });
                }
                showEditorView();
            }

            async function saveCurrentReflection() {
                if (!currentUserId) return;

                const reflectionData = {
                    title: document.getElementById('reflectionTitle').value || 'Untitled Reflection',
                    reflectionContent: reflectionQuill.root.innerHTML,
                    feedbackContent: feedbackQuill.root.innerHTML,
                    mediaUrls: Array.from(document.querySelectorAll('#mediaPreviewContainer img')).map(img => img.src),
                    updatedAt: serverTimestamp()
                };

                try {
                    if (currentReflectionId) {
                        const docRef = doc(db, 'users', currentUserId, 'reflections', currentReflectionId);
                        await updateDoc(docRef, reflectionData);
                        showAppMessage('Reflection updated!');
                    } else {
                        const collectionRef = collection(db, 'users', currentUserId, 'reflections');
                        await addDoc(collectionRef, reflectionData);
                        showAppMessage('Reflection saved!');
                    }
                    showListView();
                } catch (error) {
                    console.error("Error saving reflection:", error);
                    showAppMessage('Error: Could not save reflection.');
                }
            }
            
            async function deleteReflection(reflectionId) {
                if (!currentUserId || !reflectionId) return;
                try {
                    const docRef = doc(db, 'users', currentUserId, 'reflections', reflectionId);
                    await deleteDoc(docRef);
                    showAppMessage('Reflection deleted.');
                    showListView();
                } catch (error) {
                    console.error("Error deleting reflection:", error);
                    showAppMessage('Error: Could not delete reflection.');
                }
            }
            
            async function handleMediaUpload(event) {
                const files = event.target.files;
                const cloudName = 'dslh2taed';
                const uploadPreset = 'Dental';
                const url = `https://api.cloudinary.com/v1_1/${cloudName}/upload`;
                const mediaContainer = document.getElementById('mediaPreviewContainer');

                for (const file of files) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', uploadPreset);
                    try {
                        const response = await fetch(url, { method: 'POST', body: formData });
                        if (!response.ok) throw new Error('Upload to Cloudinary failed.');
                        const data = await response.json();
                        const img = document.createElement('img');
                        img.src = data.secure_url;
                        mediaContainer.appendChild(img);
                    } catch (error) {
                        console.error('Error uploading media:', error);
                        showAppMessage('Error uploading media.');
                    }
                }
            }

            const confirmationModal = document.getElementById('confirmationModal');
            const confirmYesBtn = document.getElementById('confirmYes');
            const confirmNoBtn = document.getElementById('confirmNo');

            function showConfirmationModal(reflectionId) {
                if (!reflectionId) return;
                confirmationModal.classList.add('active');
                confirmYesBtn.onclick = () => {
                    deleteReflection(reflectionId);
                    confirmationModal.classList.remove('active');
                };
                confirmNoBtn.onclick = () => confirmationModal.classList.remove('active');
            }

            function showAppMessage(messageText) {
                const messageElement = document.getElementById('message');
                messageElement.textContent = messageText;
                messageElement.classList.add('show-message');
                setTimeout(() => messageElement.classList.remove('show-message'), 3000);
            }

            function printPage() { window.print(); }
            
            // --- STEP 5: Netlify & Firebase Authentication Bridge ---
            async function authenticateWithFirebase() {
                const netlifyUser = netlifyIdentity.currentUser();
                if (!netlifyUser || !netlifyUser.token) {
                    console.log("Not a Netlify user or no token found.");
                    return;
                }
                
                console.log("STEP 3: Netlify user found. Requesting Firebase token...");
                try {
                    const response = await fetch('/.netlify/functions/get-firebase-token', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${netlifyUser.token.access_token}` }
                    });
                    if (!response.ok) throw new Error(`Function returned status: ${response.status}`);
                    const data = await response.json();
                    
                    console.log("STEP 4: Got Firebase token. Signing in...");
                    await signInWithCustomToken(auth, data.token);
                    console.log("STEP 5: Firebase sign-in successful!");

                } catch (error) {
                    console.error("Firebase authentication bridge failed:", error);
                    document.getElementById('app-content').innerHTML = `<div style="padding: 20px; text-align: center;"><h2>Authentication Error</h2><p>Could not sign in to the database. Please try logging out and back in.</p></div>`;
                }
            }

            onAuthStateChanged(auth, (firebaseUser) => {
                if (firebaseUser) {
                    document.getElementById('app-content').style.display = 'block';
                    if (!appIsInitialized) {
                        initializeMainApp(firebaseUser.uid);
                        appIsInitialized = true;
                    }
                }
            });

            netlifyIdentity.on('login', () => { 
                netlifyIdentity.close(); 
                authenticateWithFirebase();
            });
            netlifyIdentity.on('logout', async () => {
                if (auth.currentUser) await signOut(auth);
                window.location.reload();
            });
            netlifyIdentity.on('init', (user) => {
                if (user) {
                    authenticateWithFirebase();
                }
            });
            
            // --- Dark Mode Theme Logic ---
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                const savedTheme = localStorage.getItem('myTechnicalReflection_theme') || 'light';
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeToggle.checked = true;
                }
                themeToggle.addEventListener('change', () => {
                    document.body.classList.toggle('dark-mode');
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    localStorage.setItem('myTechnicalReflection_theme', isDarkMode ? 'dark' : 'light');
                });
            }

        } catch (error) {
            console.error("!!!!!!!!!! A FATAL ERROR OCCURRED !!!!!!!!!!", error);
            document.body.innerHTML = `<div style="padding: 40px; font-family: sans-serif; text-align: center;"><h1>Application Error</h1><p>A critical error occurred while loading the application. Please check the browser console for more details and contact support.</p></div>`;
        }
    </script>
</body>
</html>

