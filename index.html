<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflect-Dent App</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦·</text></svg>">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a202c">
    <link href="https://cdn.quilljs.com/2.0.0-rc.4/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    <style>
        /* This style block ensures the theme-toggle button is rendered correctly for your use case. */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            background: none;
            border: none;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle .icon {
            font-size: 24px;
            color: #3498db;
        }

        body.dark-mode .theme-toggle .icon {
            color: #63b3ed;
        }
    </style>
</head>
<body class="light-mode">
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
        <span class="icon" id="theme-icon">ðŸŒ™</span>
    </button>
    <main>
        <div id="authContainer" class="card">
            <img src="./company_logo.png" alt="Company Logo" class="logo">
            <h1>Welcome to Reflect-Dent</h1>
            <p>Sign in with your university email to get started.</p>
            <form id="authForm">
                <input type="email" id="emailInput" placeholder="university.email@ac.uk" required>
                <input type="password" id="passwordInput" placeholder="Password" required>
                <div class="button-group">
                    <button type="submit" id="signInBtn">Sign In</button>
                    <button type="button" id="signUpBtn" class="secondary-btn">Sign Up</button>
                </div>
            </form>
            <a href="#" id="forgotPasswordLink">Forgot Password?</a>
        </div>

        <div id="resetPasswordContainer" class="card hidden">
            <h1>Reset Password</h1>
            <p>Enter your email address to receive a password reset link.</p>
            <input type="email" id="resetEmailInput" placeholder="university.email@ac.uk" required>
            <button id="sendResetLinkBtn">Send Reset Link</button>
            <button id="backToSignInBtn" class="secondary-btn">Back to Sign In</button>
        </div>

        <div id="mainAppContainer" class="container hidden">
            <header>
                <div class="user-info">
                    <span id="userName"></span>
                    <button id="signOutBtn" class="secondary-btn">Sign Out</button>
                </div>
                <div class="user-id-display hidden">
                    <p>Your User ID: <span id="userIdDisplay"></span></p>
                </div>
            </header>

            <div id="listViewContainer">
                <div class="actions">
                    <button id="createNewBtn">+ New Reflection</button>
                    <div class="sort-filter">
                        <select id="sortSelect">
                            <option value="last-modified">Sort by: Last Modified</option>
                            <option value="creation-date">Sort by: Creation Date</option>
                            <option value="title-az">Sort by: Title (A-Z)</option>
                        </select>
                        <input type="text" id="filterInput" placeholder="Filter by title...">
                    </div>
                </div>
                <div id="reflectionsList" class="reflections-list">
                    <!-- Reflections will be loaded here -->
                </div>
            </div>

            <div id="reflectionEditorContainer" class="hidden">
                <div class="editor-header">
                    <button id="backToListBtn" class="back-btn">&#8592; Back to Reflections</button>
                    <h1>My Technical Reflection</h1>
                </div>

                <div class="editor-metadata">
                    <input type="text" id="reflectionTitle" placeholder="e.g., mandibular right first molar full gold crown" required>
                    <div class="date-info">
                        <span id="creationDate"></span>
                        <span id="lastModifiedDate"></span>
                    </div>
                </div>

                <div class="prompt-section">
                    <p class="prompt-label">Choose a prompt:</p>
                    <select id="promptSelect">
                        <option value="">Select a prompt</option>
                        <option value="What happened?">What happened?</option>
                        <option value="What were you thinking and feeling?">What were you thinking and feeling?</option>
                        <option value="What was the effect of this on you and on others?">What was the effect of this on you and on others?</option>
                        <option value="What was good and bad about the experience?">What was good and bad about the experience?</option>
                        <option value="What sense can you make of the situation?">What sense can you make of the situation?</option>
                        <option value="What are you going to do differently next time?">What are you going to do differently next time?</option>
                    </select>
                    <button id="insertPromptBtn" class="secondary-btn">Insert Prompt</button>
                </div>

                <div class="rich-text-container">
                    <div id="reflectionEditor" class="ql-container"></div>
                </div>

                <div class="feedback-section">
                    <h3>Feedback from Lecturer</h3>
                    <div class="rich-text-container">
                        <div id="feedbackEditor" class="ql-container"></div>
                    </div>
                </div>

                <div class="action-buttons">
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                    <button id="uploadImageBtn" class="btn">Upload Image</button>
                    <button id="takePhotoBtn" class="btn">Take Photo</button>
                    <button id="saveReflectionBtn" class="btn">Save Reflection</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2024 Reflect-Dent App. All Rights Reserved.</p>
            <div class="footer-links">
                <a href="./privacy_policy.html">Privacy Policy</a>
                <a href="./terms_and_conditions.html">Terms and Conditions</a>
                <a href="mailto:support@reflectdent.com">Contact Us</a>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, updateDoc, deleteDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Global variables for Firebase configuration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Quill is globally available via the script tag
        const Quill = window.Quill;

        // --- Firebase Initialisation ---
        let app, auth, db;
        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } else {
                console.warn('Firebase config is missing. App will run in limited mode without database functionality.');
            }
        } catch (error) {
            console.error('Failed to initialize Firebase:', error);
        }

        let currentReflectionId = null;
        let unsubscribeFromReflections = null;
        let isAuthReady = false;

        const authContainer = document.getElementById('authContainer');
        const resetPasswordContainer = document.getElementById('resetPasswordContainer');
        const mainAppContainer = document.getElementById('mainAppContainer');
        const reflectionsList = document.getElementById('reflectionsList');
        const reflectionEditorContainer = document.getElementById('reflectionEditorContainer');
        const reflectionTitle = document.getElementById('reflectionTitle');
        const creationDateSpan = document.getElementById('creationDate');
        const lastModifiedDateSpan = document.getElementById('lastModifiedDate');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const fileInput = document.getElementById('fileInput');

        let reflectionQuill = null;
        let feedbackQuill = null;

        const prompts = {
            "What happened?": "What happened?",
            "What were you thinking and feeling?": "What were you thinking and feeling?",
            "What was the effect of this on you and on others?": "What was the effect of this on you and on others?",
            "What was good and bad about the experience?": "What was good and bad about the experience?",
            "What sense can you make of the situation?": "What sense can you make of the situation?",
            "What are you going to do differently next time?": "What are you going to do differently next time?"
        };

        const showView = (viewId) => {
            const views = {
                authView: authContainer,
                resetView: resetPasswordContainer,
                mainAppView: mainAppContainer,
                listView: reflectionsList.parentNode,
                editorView: reflectionEditorContainer
            };

            Object.values(views).forEach(view => view.classList.add('hidden'));

            if (viewId === 'mainAppView') {
                mainAppContainer.classList.remove('hidden');
                views.listView.classList.remove('hidden');
            } else if (viewId === 'editorView') {
                mainAppContainer.classList.remove('hidden');
                views.editorView.classList.remove('hidden');
            } else {
                views[viewId].classList.remove('hidden');
            }
        };

        const setLoggedInUser = (user) => {
            const userName = user.email.split('@')[0];
            document.getElementById('userName').textContent = `Welcome, ${userName}!`;
            userIdDisplay.textContent = user.uid;
            document.querySelector('.user-id-display').classList.remove('hidden');
            showView('mainAppView');
        };

        const showError = (message) => {
            console.error(message);
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        };

        const showListView = () => {
            showView('mainAppView');
            currentReflectionId = null;
        };

        const saveCurrentReflection = async () => {
            if (!isAuthReady || !auth.currentUser) {
                showError("User not authenticated.");
                return;
            }

            const reflectionContent = reflectionQuill.getContents();
            const feedbackContent = feedbackQuill.getContents();
            const title = reflectionTitle.value.trim();

            if (title === '') {
                alert('Please enter a title for your reflection.');
                return;
            }

            const reflectionData = {
                title: title,
                reflection: JSON.stringify(reflectionContent),
                feedback: JSON.stringify(feedbackContent),
                userId: auth.currentUser.uid,
                lastModified: serverTimestamp()
            };

            const userReflectionsCollection = collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/reflections`);

            try {
                if (currentReflectionId) {
                    const docRef = doc(userReflectionsCollection, currentReflectionId);
                    await updateDoc(docRef, reflectionData);
                    console.log("Reflection updated successfully!");
                } else {
                    reflectionData.createdAt = serverTimestamp();
                    const docRef = await addDoc(userReflectionsCollection, reflectionData);
                    currentReflectionId = docRef.id;
                    console.log("Reflection saved successfully!");
                }
                showListView();
            } catch (error) {
                showError("Failed to save reflection: " + error.message);
            }
        };

        const loadReflection = async (reflectionId) => {
            if (!isAuthReady || !auth.currentUser) {
                showError("User not authenticated.");
                return;
            }
            
            const docRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/reflections`, reflectionId);

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentReflectionId = reflectionId;
                    reflectionTitle.value = data.title;
                    creationDateSpan.textContent = `Created: ${formatDate(data.createdAt)}`;
                    lastModifiedDateSpan.textContent = `Last Modified: ${formatDate(data.lastModified)}`;

                    if (data.reflection) {
                        reflectionQuill.setContents(JSON.parse(data.reflection));
                    }
                    if (data.feedback) {
                        feedbackQuill.setContents(JSON.parse(data.feedback));
                    }
                    showView('editorView');
                } else {
                    showError("No such reflection exists.");
                }
            } catch (error) {
                showError("Error loading reflection: " + error.message);
            }
        };

        const updateReflectionsList = (reflections) => {
            reflectionsList.innerHTML = '';
            reflections.forEach(doc => {
                const data = doc.data();
                const reflectionCard = document.createElement('div');
                reflectionCard.className = 'reflection-card';
                reflectionCard.innerHTML = `
                    <h3>${data.title}</h3>
                    <p>Modified: ${formatDate(data.lastModified)}</p>
                `;
                reflectionCard.addEventListener('click', () => loadReflection(doc.id));
                reflectionsList.appendChild(reflectionCard);
            });
        };

        const listenForReflections = () => {
            if (unsubscribeFromReflections) {
                unsubscribeFromReflections();
            }

            if (!db || !auth.currentUser) {
                console.error("Database or user not ready.");
                return;
            }

            const userReflectionsCollection = collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/reflections`);
            const q = query(userReflectionsCollection);
            unsubscribeFromReflections = onSnapshot(q, (snapshot) => {
                const reflections = [];
                snapshot.forEach(doc => {
                    reflections.push(doc);
                });
                updateReflectionsList(reflections);
            }, (error) => {
                showError("Error listening to reflections: " + error.message);
            });
        };
        
        const deleteReflection = async () => {
             if (!currentReflectionId) return;

             if (confirm('Are you sure you want to delete this reflection?')) {
                 const docRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/reflections`, currentReflectionId);
                 try {
                     await deleteDoc(docRef);
                     console.log("Reflection deleted successfully!");
                     showListView();
                 } catch (error) {
                     showError("Error deleting reflection: " + error.message);
                 }
             }
         };

        const initializeMainApp = () => {
            if (reflectionQuill) {
                reflectionQuill.off('editor-change', handleEditorChange);
            }
            reflectionQuill = new Quill('#reflectionEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'header': 1 }, { 'header': 2 }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['blockquote', 'code-block'],
                        ['link', 'image'],
                        [{ 'align': [] }],
                        [{ 'color': [] }, { 'background': [] }]
                    ]
                }
            });

            if (feedbackQuill) {
                feedbackQuill.off('editor-change', handleEditorChange);
            }
            feedbackQuill = new Quill('#feedbackEditor', {
                theme: 'snow',
                readOnly: true,
                modules: {
                    toolbar: false
                }
            });
            
            // Custom Image Handler for Quill
            const imageHandler = () => {
                fileInput.click();
            };
            reflectionQuill.getModule('toolbar').addHandler('image', imageHandler);

            reflectionQuill.on('editor-change', handleEditorChange);

            document.getElementById('createNewBtn').addEventListener('click', () => {
                currentReflectionId = null;
                reflectionTitle.value = '';
                reflectionQuill.setContents([]);
                feedbackQuill.setContents([]);
                creationDateSpan.textContent = '';
                lastModifiedDateSpan.textContent = '';
                showView('editorView');
            });
            document.getElementById('backToListBtn').addEventListener('click', showListView);
            document.getElementById('saveReflectionBtn').addEventListener('click', saveCurrentReflection);
            document.getElementById('insertPromptBtn').addEventListener('click', () => {
                const select = document.getElementById('promptSelect');
                const promptText = prompts[select.value];
                if (promptText) {
                     const delta = reflectionQuill.clipboard.convert({ html: `<strong>${promptText}</strong><br><br>` });
                     reflectionQuill.setContents(delta, 'user');
                     reflectionQuill.setSelection(reflectionQuill.getLength(), 0);
                }
            });
            
            document.getElementById('uploadImageBtn').addEventListener('click', () => {
                fileInput.removeAttribute('capture');
                fileInput.click();
            });

            document.getElementById('takePhotoBtn').addEventListener('click', () => {
                fileInput.setAttribute('capture', 'user');
                fileInput.click();
            });
            
            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const storage = getStorage(app);
                const storageRef = ref(storage, `images/${auth.currentUser.uid}/${file.name}-${Date.now()}`);

                try {
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);

                    const range = reflectionQuill.getSelection(true);
                    reflectionQuill.insertEmbed(range.index, 'image', downloadURL, 'user');
                    reflectionQuill.setSelection(range.index + 1);

                } catch (error) {
                    console.error("Failed to upload image:", error);
                }
            });

            document.getElementById('sortSelect').addEventListener('change', (e) => sortReflections(e.target.value));
            document.getElementById('filterInput').addEventListener('input', (e) => filterReflections(e.target.value));
            document.getElementById('signOutBtn').addEventListener('click', () => signOut(auth));
            
            listenForReflections();
        };

        const sortReflections = (sortBy) => {
            const children = Array.from(reflectionsList.children);
            children.sort((a, b) => {
                const aData = a.dataset;
                const bData = b.dataset;
                if (sortBy === 'last-modified') {
                    return bData.lastModified - aData.lastModified;
                } else if (sortBy === 'creation-date') {
                    return bData.createdAt - aData.createdAt;
                } else if (sortBy === 'title-az') {
                    return aData.title.localeCompare(bData.title);
                }
                return 0;
            });
            children.forEach(child => reflectionsList.appendChild(child));
        };

        const filterReflections = (filterText) => {
            const cards = reflectionsList.querySelectorAll('.reflection-card');
            cards.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                if (title.includes(filterText.toLowerCase())) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        };

        const handleEditorChange = (delta, oldDelta, source) => {
            // This can be used for more advanced features like autosaving
        };

        // Theme Toggle
        const currentTheme = localStorage.getItem('myTechnicalReflection_theme');
        if (currentTheme) {
            document.body.classList.remove('light-mode', 'dark-mode');
            document.body.classList.add(currentTheme);
        } else {
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (systemPrefersDark) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.add('light-mode');
            }
        }
        themeToggle.addEventListener('click', () => {
            if (document.body.classList.contains('light-mode')) {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                localStorage.setItem('myTechnicalReflection_theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                localStorage.setItem('myTechnicalReflection_theme', 'light');
            }
        });

        // Auth state listener
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                isAuthReady = true;
                if (user) {
                    setLoggedInUser(user);
                    initializeMainApp();
                } else {
                    showView('authView');
                    document.querySelector('.user-id-display').classList.add('hidden');
                }
            });
        }
    </script>
</body>
</html>
