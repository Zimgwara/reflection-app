<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflect-Dent App</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦·</text></svg>">
    <link href="https://cdn.quilljs.com/2.0.0-rc.4/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HJ0F5QXH1W"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-HJ0F5QXH1W');
    </script>
    <style>
        /* All CSS from the original style.css file is now here */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        body.light-mode {
            background-color: #f7fafc;
            color: #2d3748;
        }

        body.dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        
        body.dark-mode a {
            color: #63b3ed;
        }

        .hidden {
            display: none !important;
        }
        
        .logo {
            width: 128px;
            height: 128px;
            margin-bottom: 20px;
        }

        .card {
            background-color: #fff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            text-align: center;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode .card {
            background-color: #2d3748;
            color: #e2e8f0;
        }

        .card h1 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #1a202c;
        }
        
        body.dark-mode .card h1 {
            color: #e2e8f0;
        }

        .card p {
            margin-bottom: 20px;
            color: #718096;
        }
        
        body.dark-mode .card p {
            color: #a0aec0;
        }

        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.3s, background-color 0.3s;
            font-size: 1rem;
        }
        
        body.dark-mode input {
            background-color: #4a5568;
            border-color: #4a5568;
            color: #e2e8f0;
        }

        input::placeholder {
            color: #a0aec0;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        #signInBtn, #sendResetLinkBtn, #saveReflectionBtn, .btn {
            background-color: #3498db;
            color: #fff;
        }

        #signUpBtn, .secondary-btn, #backToSignInBtn {
            background-color: #e2e8f0;
            color: #2d3748;
        }
        
        body.dark-mode #signUpBtn, body.dark-mode .secondary-btn, body.dark-mode #backToSignInBtn {
            background-color: #4a5568;
            color: #e2e8f0;
        }

        .message-box {
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
        }

        .message-box.error {
            background-color: #fee2e2;
            color: #c53030;
        }

        .message-box.success {
            background-color: #f0fff4;
            color: #2f855a;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .reflections-list {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }

        .reflection-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
            text-align: left;
        }
        
        body.dark-mode .reflection-card {
            background-color: #2d3748;
        }

        .reflection-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .reflection-card h3 {
            margin: 0;
            font-size: 1.25rem;
            color: #1a202c;
        }
        
        body.dark-mode .reflection-card h3 {
            color: #e2e8f0;
        }

        .reflection-card p {
            margin: 5px 0 0;
            font-size: 0.875rem;
            color: #718096;
        }

        .actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .sort-filter {
            display: flex;
            gap: 10px;
        }

        #sortSelect, #filterInput {
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.875rem;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .editor-header h1 {
            font-size: 1.5rem;
        }

        .editor-metadata {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        #reflectionTitle {
            flex-grow: 1;
        }

        .ql-toolbar.ql-snow, .ql-container.ql-snow {
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }
        
        body.dark-mode .ql-toolbar.ql-snow, body.dark-mode .ql-container.ql-snow {
            border-color: #4a5568;
        }

        body.dark-mode .ql-editor {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        body.dark-mode .ql-snow .ql-stroke {
            stroke: #a0aec0;
        }
        body.dark-mode .ql-snow .ql-fill {
            fill: #a0aec0;
        }

        .rich-text-container {
            min-height: 200px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        .delete-btn {
            background-color: #e74c3c;
            color: #fff;
        }
        
        .prompt-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .prompt-label {
            margin: 0;
            font-weight: 600;
        }
        
        #promptSelect {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .back-btn {
            background: none;
            border: none;
            color: #3498db;
            font-weight: 600;
            cursor: pointer;
        }

        /* This style block ensures the theme-toggle button is rendered correctly for your use case. */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            background: none;
            border: none;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle .icon {
            font-size: 24px;
            color: #3498db;
        }

        body.dark-mode .theme-toggle .icon {
            color: #63b3ed;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-container {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 300px;
        }

        .modal-container.dark-mode {
            background: #2d3748;
            color: #e2e8f0;
        }

        .modal-container h3 {
            margin-top: 0;
            color: #1a202c;
        }
        .modal-container.dark-mode h3 {
            color: #e2e8f0;
        }

        .modal-container p {
            margin-bottom: 20px;
        }

        .modal-container .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .modal-container button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .modal-container button.confirm-btn {
            background: #e74c3c;
            color: #fff;
        }

        .modal-container button.cancel-btn {
            background: #ccc;
            color: #333;
        }
        body.dark-mode .modal-container button.cancel-btn {
            background: #4a5568;
            color: #e2e8f0;
        }
    </style>
</head>
<body class="light-mode">
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
        <span class="icon" id="theme-icon">ðŸŒ™</span>
    </button>
    <main>
        <div id="authContainer" class="card">
            <img src="https://placehold.co/128x128/3498db/ffffff?text=Reflect-Dent+Logo" alt="Company Logo" class="logo">
            <h1>Welcome to ReflectDent</h1>
            <p>Sign in with your university email to get started.</p>
            <form id="authForm">
                <input type="email" id="emailInput" placeholder="st.....@outlook.cardiffmet.ac.uk" required>
                <input type="password" id="passwordInput" placeholder="Password" required>
                <div class="button-group">
                    <button type="submit" id="signInBtn">Sign In</button>
                    <button type="button" id="signUpBtn" class="secondary-btn">Sign Up</button>
                </div>
            </form>
            <div id="authMessage" class="message-box" style="margin-top: 15px;"></div>
            <a href="#" id="forgotPasswordLink">Forgot Password?</a>
        </div>

        <div id="resetPasswordContainer" class="card hidden">
            <h1>Reset Password</h1>
            <p>Enter your email address to receive a password reset link.</p>
            <input type="email" id="resetEmailInput" placeholder="st.....@outlook.cardiffmet.ac.uk" required>
            <button id="sendResetLinkBtn">Send Reset Link</button>
            <button id="backToSignInBtn" class="secondary-btn">Back to Sign In</button>
        </div>

        <div id="mainAppContainer" class="container hidden">
            <header>
                <div class="user-info">
                    <span id="userName"></span>
                    <button id="signOutBtn" class="secondary-btn">Sign Out</button>
                </div>
                <div class="user-id-display hidden">
                    <p>Your User ID: <span id="userIdDisplay"></span></p>
                </div>
            </header>

            <div id="listViewContainer">
                <div class="actions">
                    <button id="createNewBtn">+ New Reflection</button>
                    <div class="sort-filter">
                        <select id="sortSelect">
                            <option value="last-modified">Sort by: Last Modified</option>
                            <option value="creation-date">Sort by: Creation Date</option>
                            <option value="title-az">Sort by: Title (A-Z)</option>
                        </select>
                        <input type="text" id="filterInput" placeholder="Filter by title...">
                    </div>
                </div>
                <div id="reflectionsList" class="reflections-list">
                    <!-- Reflections will be loaded here -->
                </div>
            </div>

            <div id="reflectionEditorContainer" class="hidden">
                <div class="editor-header">
                    <button id="backToListBtn" class="back-btn">&#8592; Back to Reflections</button>
                    <h1>My Technical Reflection</h1>
                    <button id="deleteReflectionBtn" class="btn delete-btn">Delete Reflection</button>
                </div>

                <div class="editor-metadata">
                    <input type="text" id="reflectionTitle" placeholder="e.g., mandibular right first molar full gold crown" required>
                    <div class="date-info">
                        <span id="creationDate"></span>
                        <span id="lastModifiedDate"></span>
                    </div>
                </div>

                <div class="prompt-section">
                    <p class="prompt-label">Choose a prompt:</p>
                    <select id="promptSelect">
                        <option value="">Select a prompt</option>
                        <option value="What happened?">What happened?</option>
                        <option value="What were you thinking and feeling?">What were you thinking and feeling?</option>
                        <option value="What was the effect of this on you and on others?">What was the effect of this on you and on others?</option>
                        <option value="What was good and bad about the experience?">What was good and bad about the experience?</option>
                        <option value="What sense can you make of the situation?">What sense can you make of the situation?</option>
                        <option value="What are you going to do differently next time?">What are you going to do differently next time?</option>
                    </select>
                    <button id="insertPromptBtn" class="secondary-btn">Insert Prompt</button>
                </div>

                <div class="rich-text-container">
                    <div id="reflectionEditor" class="ql-container"></div>
                </div>

                <div class="feedback-section">
                    <h3>Feedback from Lecturer</h3>
                    <div class="rich-text-container">
                        <div id="feedbackEditor" class="ql-container"></div>
                    </div>
                </div>

                <div class="action-buttons">
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                    <button id="uploadImageBtn" class="btn">Upload Image</button>
                    <button id="takePhotoBtn" class="btn">Take Photo</button>
                    <button id="saveReflectionBtn" class="btn">Save Reflection</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Custom Modal for Alerts/Confirms -->
    <div id="customModal" class="modal-overlay hidden">
        <div class="modal-container">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div id="modalButtons" class="modal-buttons">
                <!-- Buttons will be inserted here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, updateDoc, deleteDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Initialisation ---
        let app, auth, db;
        
        // Use the global variables provided by the platform
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } else {
                console.warn('Firebase config is missing. App will run in limited mode without database functionality.');
            }
        } catch (error) {
            console.error('Failed to initialize Firebase:', error);
        }

        let currentReflectionId = null;
        let unsubscribeFromReflections = null;
        let isAuthReady = false;

        const authContainer = document.getElementById('authContainer');
        const resetPasswordContainer = document.getElementById('resetPasswordContainer');
        const mainAppContainer = document.getElementById('mainAppContainer');
        const reflectionsList = document.getElementById('reflectionsList');
        const reflectionEditorContainer = document.getElementById('reflectionEditorContainer');
        const reflectionTitle = document.getElementById('reflectionTitle');
        const creationDateSpan = document.getElementById('creationDate');
        const lastModifiedDateSpan = document.getElementById('lastModifiedDate');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const fileInput = document.getElementById('fileInput');
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalButtons = document.getElementById('modalButtons');
        
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const resetEmailInput = document.getElementById('resetEmailInput');

        let reflectionQuill = null;
        let feedbackQuill = null;
        
        const authMessage = document.getElementById('authMessage');

        const prompts = {
            "What happened?": "What happened?",
            "What were you thinking and feeling?": "What were you thinking and feeling?",
            "What was the effect of this on you and on others?": "What was the effect of this on you and on others?",
            "What was good and bad about the experience?": "What was good and bad about the experience?",
            "What sense can you make of the situation?": "What sense can you make of the situation?",
            "What are you going to do differently next time?": "What are you going to do differently next time?"
        };

        const showView = (viewId) => {
            const views = {
                authView: authContainer,
                resetView: resetPasswordContainer,
                mainAppView: mainAppContainer,
                listView: reflectionsList.parentNode,
                editorView: reflectionEditorContainer
            };

            Object.values(views).forEach(view => view.classList.add('hidden'));

            if (viewId === 'mainAppView') {
                mainAppContainer.classList.remove('hidden');
                views.listView.classList.remove('hidden');
            } else if (viewId === 'editorView') {
                mainAppContainer.classList.remove('hidden');
                views.editorView.classList.remove('hidden');
            } else {
                views[viewId].classList.remove('hidden');
            }
        };

        const setLoggedInUser = (user) => {
            const userName = user.email ? user.email.split('@')[0] : 'Guest';
            document.getElementById('userName').textContent = `Welcome, ${userName}!`;
            userIdDisplay.textContent = user.uid;
            document.querySelector('.user-id-display').classList.remove('hidden');
            showView('mainAppView');
        };

        const showError = (message) => {
            console.error(message);
            authMessage.textContent = message;
            authMessage.style.color = '#e74c3c';
        };
        
        const showSuccess = (message) => {
            authMessage.textContent = message;
            authMessage.style.color = '#2ecc71';
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        };

        const showListView = () => {
            showView('mainAppView');
            currentReflectionId = null;
        };

        const showCustomModal = (title, message, isConfirm, onConfirm, onCancel) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = '';
            
            if (isConfirm) {
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'OK';
                confirmBtn.className = 'confirm-btn';
                confirmBtn.addEventListener('click', () => {
                    if (onConfirm) onConfirm();
                    customModal.classList.add('hidden');
                });
                modalButtons.appendChild(confirmBtn);

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancel';
                cancelBtn.className = 'cancel-btn';
                cancelBtn.addEventListener('click', () => {
                    if (onCancel) onCancel();
                    customModal.classList.add('hidden');
                });
                modalButtons.appendChild(cancelBtn);

            } else {
                const okBtn = document.createElement('button');
                okBtn.textContent = 'OK';
                okBtn.className = 'confirm-btn';
                okBtn.addEventListener('click', () => {
                    customModal.classList.add('hidden');
                });
                modalButtons.appendChild(okBtn);
            }
            customModal.classList.remove('hidden');
        };

        const saveCurrentReflection = async () => {
            if (!isAuthReady || !auth.currentUser) {
                showError("User not authenticated.");
                return;
            }

            const reflectionContent = reflectionQuill.getContents();
            const feedbackContent = feedbackQuill.getContents();
            const title = reflectionTitle.value.trim();

            if (title === '') {
                showCustomModal('Error', 'Please enter a title for your reflection.', false);
                return;
            }

            const reflectionData = {
                title: title,
                reflection: JSON.stringify(reflectionContent),
                feedback: JSON.stringify(feedbackContent),
                userId: auth.currentUser.uid,
                lastModified: serverTimestamp()
            };

            const userReflectionsCollection = collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/reflections`);

            try {
                if (currentReflectionId) {
                    const docRef = doc(userReflectionsCollection, currentReflectionId);
                    await updateDoc(docRef, reflectionData);
                    console.log("Reflection updated successfully!");
                } else {
                    reflectionData.createdAt = serverTimestamp();
                    const docRef = await addDoc(userReflectionsCollection, reflectionData);
                    currentReflectionId = docRef.id;
                    console.log("Reflection saved successfully!");
                }
                showListView();
            } catch (error) {
                showError("Failed to save reflection: " + error.message);
            }
        };

        const loadReflection = async (reflectionId) => {
            if (!isAuthReady || !auth.currentUser) {
                showError("User not authenticated.");
                return;
            }
            
            const docRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/reflections`, reflectionId);

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentReflectionId = reflectionId;
                    reflectionTitle.value = data.title;
                    creationDateSpan.textContent = `Created: ${formatDate(data.createdAt)}`;
                    lastModifiedDateSpan.textContent = `Last Modified: ${formatDate(data.lastModified)}`;

                    if (data.reflection) {
                        reflectionQuill.setContents(JSON.parse(data.reflection));
                    }
                    if (data.feedback) {
                        feedbackQuill.setContents(JSON.parse(data.feedback));
                    }
                    showView('editorView');
                } else {
                    showError("No such reflection exists.");
                }
            } catch (error) {
                showError("Error loading reflection: " + error.message);
            }
        };

        const updateReflectionsList = (reflections) => {
            reflectionsList.innerHTML = '';
            reflections.forEach(doc => {
                const data = doc.data();
                const reflectionCard = document.createElement('div');
                reflectionCard.className = 'reflection-card';
                reflectionCard.dataset.title = data.title;
                reflectionCard.dataset.createdAt = data.createdAt ? data.createdAt.toMillis() : 0;
                reflectionCard.dataset.lastModified = data.lastModified ? data.lastModified.toMillis() : 0;
                reflectionCard.innerHTML = `
                    <h3>${data.title}</h3>
                    <p>Modified: ${formatDate(data.lastModified)}</p>
                `;
                reflectionCard.addEventListener('click', () => loadReflection(doc.id));
                reflectionsList.appendChild(reflectionCard);
            });
        };

        const listenForReflections = () => {
            if (unsubscribeFromReflections) {
                unsubscribeFromReflections();
            }

            if (!db || !auth.currentUser) {
                console.error("Database or user not ready.");
                return;
            }

            const userReflectionsCollection = collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/reflections`);
            const q = query(userReflectionsCollection);
            unsubscribeFromReflections = onSnapshot(q, (snapshot) => {
                const reflections = [];
                snapshot.forEach(doc => {
                    reflections.push(doc);
                });
                updateReflectionsList(reflections);
            }, (error) => {
                showError("Error listening to reflections: " + error.message);
            });
        };
        
        const deleteReflection = async () => {
            if (!currentReflectionId) return;
            
            showCustomModal('Delete Reflection', 'Are you sure you want to delete this reflection?', true, async () => {
                const docRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/reflections`, currentReflectionId);
                try {
                    await deleteDoc(docRef);
                    console.log("Reflection deleted successfully!");
                    showListView();
                } catch (error) {
                    showError("Error deleting reflection: " + error.message);
                }
            });
        };

        const initializeMainApp = () => {
            if (reflectionQuill) {
                reflectionQuill.off('editor-change', handleEditorChange);
            }
            reflectionQuill = new Quill('#reflectionEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'header': 1 }, { 'header': 2 }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['blockquote', 'code-block'],
                        ['link', 'image'],
                        [{ 'align': [] }],
                        [{ 'color': [] }, { 'background': [] }]
                    ]
                }
            });

            if (feedbackQuill) {
                feedbackQuill.off('editor-change', handleEditorChange);
            }
            feedbackQuill = new Quill('#feedbackEditor', {
                theme: 'snow',
                readOnly: true,
                modules: {
                    toolbar: false
                }
            });
            
            // Custom Image Handler for Quill
            const imageHandler = () => {
                fileInput.click();
            };
            reflectionQuill.getModule('toolbar').addHandler('image', imageHandler);

            reflectionQuill.on('editor-change', handleEditorChange);

            document.getElementById('createNewBtn').addEventListener('click', () => {
                currentReflectionId = null;
                reflectionTitle.value = '';
                reflectionQuill.setContents([]);
                feedbackQuill.setContents([]);
                creationDateSpan.textContent = '';
                lastModifiedDateSpan.textContent = '';
                showView('editorView');
            });
            document.getElementById('backToListBtn').addEventListener('click', showListView);
            document.getElementById('saveReflectionBtn').addEventListener('click', saveCurrentReflection);
            document.getElementById('deleteReflectionBtn').addEventListener('click', deleteReflection);
            document.getElementById('insertPromptBtn').addEventListener('click', () => {
                const select = document.getElementById('promptSelect');
                const promptText = prompts[select.value];
                if (promptText) {
                    const delta = reflectionQuill.clipboard.convert({ html: `<strong>${promptText}</strong><br><br>` });
                    reflectionQuill.setContents(delta, 'user');
                    reflectionQuill.setSelection(reflectionQuill.getLength(), 0);
                }
            });
            
            document.getElementById('uploadImageBtn').addEventListener('click', () => {
                fileInput.removeAttribute('capture');
                fileInput.click();
            });

            document.getElementById('takePhotoBtn').addEventListener('click', () => {
                fileInput.setAttribute('capture', 'user');
                fileInput.click();
            });
            
            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const storage = getStorage(app);
                const storageRef = ref(storage, `images/${auth.currentUser.uid}/${file.name}-${Date.now()}`);

                try {
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);

                    const range = reflectionQuill.getSelection(true);
                    reflectionQuill.insertEmbed(range.index, 'image', downloadURL, 'user');
                    reflectionQuill.setSelection(range.index + 1);

                } catch (error) {
                    console.error("Failed to upload image:", error);
                }
            });

            document.getElementById('sortSelect').addEventListener('change', (e) => sortReflections(e.target.value));
            document.getElementById('filterInput').addEventListener('input', (e) => filterReflections(e.target.value));
            document.getElementById('signOutBtn').addEventListener('click', () => signOut(auth));
            
            listenForReflections();
        };

        const sortReflections = (sortBy) => {
            const children = Array.from(reflectionsList.children);
            children.sort((a, b) => {
                const aData = a.dataset;
                const bData = b.dataset;
                if (sortBy === 'last-modified') {
                    return bData.lastModified - aData.lastModified;
                } else if (sortBy === 'creation-date') {
                    return bData.createdAt - aData.createdAt;
                } else if (sortBy === 'title-az') {
                    return aData.title.localeCompare(bData.title);
                }
                return 0;
            });
            children.forEach(child => reflectionsList.appendChild(child));
        };

        const filterReflections = (filterText) => {
            const cards = reflectionsList.querySelectorAll('.reflection-card');
            cards.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                if (title.includes(filterText.toLowerCase())) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        };

        const handleEditorChange = (delta, oldDelta, source) => {
            // This can be used for more advanced features like autosaving
        };

        // Theme Toggle
        const currentTheme = localStorage.getItem('myTechnicalReflection_theme');
        if (currentTheme) {
            document.body.classList.remove('light-mode', 'dark-mode');
            document.body.classList.add(currentTheme);
        } else {
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (systemPrefersDark) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.add('light-mode');
            }
        }
        themeToggle.addEventListener('click', () => {
            if (document.body.classList.contains('light-mode')) {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                localStorage.setItem('myTechnicalReflection_theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                localStorage.setItem('myTechnicalReflection_theme', 'light');
            }
        });

        // Event listeners and initial auth logic moved into this block
        if (auth) {
            // Use the token if it exists, otherwise sign in anonymously
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken);
            } else {
                signInAnonymously(auth);
            }

            // Auth state listener
            onAuthStateChanged(auth, (user) => {
                isAuthReady = true;
                if (user) {
                    setLoggedInUser(user);
                    initializeMainApp();
                } else {
                    showView('authView');
                    document.querySelector('.user-id-display').classList.add('hidden');
                }
            });

            // Event listeners for auth buttons
            document.getElementById('authForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = emailInput.value;
                const password = passwordInput.value;
                authMessage.textContent = 'Signing in...';
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showSuccess('Signed in successfully!');
                    showView('mainAppView');
                } catch (error) {
                    showError('Sign-in failed: ' + error.message);
                }
            });

            document.getElementById('signUpBtn').addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;
                authMessage.textContent = 'Creating account...';
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showSuccess('Account created successfully!');
                    showView('mainAppView');
                } catch (error) {
                    showError('Sign-up failed: ' + error.message);
                }
            });

            document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
                e.preventDefault();
                showView('resetView');
            });

            document.getElementById('sendResetLinkBtn').addEventListener('click', async () => {
                const email = resetEmailInput.value;
                if (email) {
                    authMessage.textContent = 'Sending reset link...';
                    try {
                        await sendPasswordResetEmail(auth, email);
                        showSuccess('Password reset email sent. Please check your inbox.');
                        showView('authView');
                    } catch (error) {
                        showError('Password reset failed: ' + error.message);
                    }
                }
            });

            document.getElementById('backToSignInBtn').addEventListener('click', () => {
                showView('authView');
            });
        }
    </script>
</body>
</html>
