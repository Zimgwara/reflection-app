<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Technical Reflection App</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <meta name="theme-color" content="#2c3e50">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.4/dist/quill.snow.css" rel="stylesheet">
    
    <!-- Netlify Identity Widget Script -->
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <!-- Firebase Config Setup -->
    <script>
      // Replace this with your actual Firebase config object
      window.firebaseConfig = {
        apiKey: "AIzaSyBif3Ejzt-KiY1vDyFPtRQjX5ne-SnV4dM",
        authDomain: "reflectdent-74d8c.firebaseapp.com",
        projectId: "reflectdent-74d8c",
        storageBucket: "reflectdent-74d8c.appspot.com",
        messagingSenderId: "510796139347",
        appId: "1:510796139347:web:426f0414b5f20f350f2fa6"
      };
    </script>
</head>
<body>
    <div class="app-wrapper">
        <div data-netlify-identity-button></div>

        <div id="app-content" style="display: none;">
            
            <div id="reflections-list-view">
                <div class="list-header">
                    <h2>My Reflections</h2>
                    <button id="newReflectionBtn" class="new-reflection-btn">+ New Reflection</button>
                </div>
                <div id="reflections-list-container"></div>
            </div>

            <main class="container" id="editor-view" style="display: none;">
                <div class="top-header">
                    <div class="logo-container">
                        <img src="company_logo.png" alt="Logo" class="company-logo" onerror="this.onerror=null;this.src='https://placehold.co/160x80/cccccc/333333?text=Logo';">
                    </div>
                    <div class="theme-switch-wrapper top-right-corner">
                        <label class="theme-switch" for="themeToggle">
                            <input type="checkbox" id="themeToggle" role="switch">
                            <div class="slider round"></div>
                        </label>
                        <span class="theme-label">Dark Mode</span>
                    </div>
                </div>

                <input type="text" id="reflectionTitle" class="reflection-title-input" placeholder="Give your reflection a title...">
                
                <p class="last-saved-timestamp" id="lastSavedTimestamp">Not saved yet</p>
                
                <div class="section-block">
                    <h2>Your Reflection:</h2>
                    <div id="reflection" class="quill-editor"></div>
                </div>
                <div class="section-block">
                    <h2>Attach Relevant Media</h2>
                    <div class="image-upload-section">
                        <div class="image-upload-buttons">
                            <label class="custom-file-upload" for="imageUploadCamera">üì∏ Take Photo</label>
                            <input type="file" id="imageUploadCamera" accept="image/*" capture="camera" multiple>
                            <label class="custom-file-upload" for="imageUploadGallery">üñºÔ∏è Upload Image</label>
                            <input type="file" id="imageUploadGallery" accept="image/*" multiple>
                             <label class="custom-file-upload" for="videoUploadCamera">üìπ Record Video</label>
                            <input type="file" id="videoUploadCamera" accept="video/*" capture="user" multiple>
                            <label class="custom-file-upload" for="videoUploadGallery">üé¨ Upload Video</label>
                            <input type="file" id="videoUploadGallery" accept="video/*" multiple>
                        </div>
                        <div id="mediaPreviewContainer">
                            <span class="no-media-selected" id="noMediaMessage">No media selected yet.</span>
                        </div>
                    </div>
                </div>
                <div class="section-block" id="lecturerFeedbackSection">
                    <h2>Lecturer Feedback</h2>
                    <div id="feedback" class="quill-editor"></div>
                </div>

                <div class="action-button-group">
                    <button id="saveReflectionBtn" class="action-btn save-btn">Save Reflection</button>
                    <button id="deleteReflectionBtn" class="action-btn delete-btn" style="display: none;">Delete</button>
                    <button class="action-btn" onclick="printPage()">Print / Save as PDF</button>
                </div>
                <button id="backToListBtn" class="back-btn">‚Üê Back to List</button>
                <p id="message" aria-live="polite"></p> 
            </main>
        </div>
    </div>

    <!-- Deletion Confirmation Modal -->
    <div id="deleteConfirmationModal" class="modal-overlay">
        <div class="modal-content">
            <p>Are you sure you want to delete this reflection? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button id="confirmDeleteBtn" class="modal-btn confirm-yes-btn">Yes, Delete</button>
                <button id="cancelDeleteBtn" class="modal-btn confirm-no-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Script Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.4/dist/quill.min.js"></script>
    <script type="module" src="script.js"></script>

    <!-- Main Controller Script (Initializes Firebase & App) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        let appInitialized = false;
        
        const app = initializeApp(window.firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const getFirebaseToken = async (netlifyToken) => {
            const response = await fetch('/.netlify/functions/get-firebase-token', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${netlifyToken}`
                }
            });
            if (!response.ok) {
                const errorBody = await response.text();
                console.error("Token function failed:", errorBody);
                throw new Error('Failed to get Firebase token.');
            }
            const { token } = await response.json();
            return token;
        }

        onAuthStateChanged(auth, user => {
            const appContent = document.getElementById('app-content');
            if (user) {
                appContent.style.display = 'block';
                if (!appInitialized) {
                    window.initializeApp(db, user.uid);
                    appInitialized = true;
                }
            } else {
                appContent.style.display = 'none';
            }
        });
        
        const handleLogin = async (user) => {
            try {
                const firebaseToken = await getFirebaseToken(user.token.access_token);
                await signInWithCustomToken(auth, firebaseToken);
            } catch (error) {
                console.error("Firebase sign-in failed:", error);
            } finally {
                netlifyIdentity.close();
            }
        };
        
        netlifyIdentity.on('login', handleLogin);

        netlifyIdentity.on('logout', () => {
            auth.signOut();
            window.location.reload();
        });
        
        netlifyIdentity.on('init', (user) => {
            if (user) {
                handleLogin(user);
            }
        });
    </script>
    <script>
        // Standalone Dark Mode Logic
        const themeToggle = document.getElementById('themeToggle');
        if(themeToggle){
            const body = document.body;
            const themeKey = 'myTechnicalReflection_theme';
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    body.classList.add('dark-mode');
                    themeToggle.checked = true;
                } else {
                    body.classList.remove('dark-mode');
                    themeToggle.checked = false;
                }
            };
            const savedTheme = localStorage.getItem(themeKey);
            applyTheme(savedTheme);
            themeToggle.addEventListener('change', () => {
                const isDarkMode = themeToggle.checked;
                localStorage.setItem(themeKey, isDarkMode ? 'dark' : 'light');
                applyTheme(isDarkMode ? 'dark' : 'light');
            });
        }
    </script>
</body>
</html>

